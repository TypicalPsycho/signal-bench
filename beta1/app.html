<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SignalBench beta | App</title>
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="icons/favicon/site.webmanifest" />
  <link rel="stylesheet" href="ui_shell.css" />
  <script src="ui_theme.js"></script>
  <script src="ui_store.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ibarra+Real+Nova:wght@500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap');

    :root{
      --bg:#f7f3ee;
      --ink:#1d232a;
      --muted:#5f6b73;
      --line:#c9c3bb;
      --soft:#e6dfd6;
      --panel:#fbf9f6;
      --active:#efe6da;
      --accent:#0f5f63;
      --radius:10px;

      --sans: "Source Sans 3", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --serif: "Ibarra Real Nova", Georgia, "Times New Roman", serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #f7f3ee 0%, #f0ece6 100%);
      color:var(--ink);
      font-family:var(--sans);
    }
        
    /* App window */
    .wrap{
      height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:16px;
      width:100%;
    }
    .app{
      width:100%;
      max-width:none;
      border:1px solid var(--line);
      display:grid;
      grid-template-columns: 280px minmax(0, 1fr);
      grid-template-rows: 1fr;
      background:var(--panel);
      box-shadow:0 18px 40px rgba(29,35,42,.08);
      border-radius:16px;
      overflow:hidden;
    }
    @media (max-width: 768px){
      .wrap{padding:4px;}
      .app{border-radius:12px;}
      aside{display:none !important;}
      .app{grid-template-columns: 1fr !important;}
    }
    @media (min-width: 1024px){
      aside{display:flex;}
      .app{grid-template-columns: 280px minmax(0, 1fr);}
    }

    /* Title bar (in-app, not browser tab) */
    .titlebar{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      letter-spacing:.2px;
      font-size:var(--fs-24);
      font-family:var(--serif);
    }
    .brand small{
      font-weight:700;
      color:var(--muted);
      margin-left:6px;
      font-size:var(--fs-14);
    }
    .mark{
      display:flex;
      align-items:flex-end;
      gap:2px;
      height:18px;
    }
    .bar{width:4px;background:#111;border-radius:2px}
    .bar:nth-child(1){height:8px}
    .bar:nth-child(2){height:12px}
    .bar:nth-child(3){height:16px}
    .tie{
      height:16px;
      width:6px;
      background:#fff;
      border:2px solid #111;
      border-radius:3px;
      margin-left:2px;
    }

    .win-controls{
      display:flex;
      gap:10px;
      align-items:center;
      user-select:none;
      font-family:var(--mono);
      font-weight:900;
    }
    .ctrl{
      width:18px;height:18px;border:1px solid #111; display:grid; place-items:center;
      font-size:var(--fs-12); line-height:1;
    }
    .ctrl.min{border:none;width:auto}
    .ctrl.min::before{content:"—";}
    .ctrl.max{background:#fff}
    .ctrl.close{border:none;width:auto}
    .ctrl.close::before{content:"X";}

    /* Sidebar */
    aside{
      grid-row:1;
      border-right:none;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sidebar-top{
      padding:14px 12px;
    }
    .sidebar-brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-family:var(--serif);
      font-size:var(--fs-28);
      font-weight:700;
      margin-bottom:16px;
      color:inherit;
    }
    .sidebar-brand img{
      width:40px;
      height:40px;
      border-radius:50%;
      display:block;
    }
    .sidebar-title{
      font-weight:900;
      font-size:var(--fs-14);
      margin:0 0 10px 0;
    }
    .new-casefile{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:var(--fs-14);
      cursor:pointer;
      background:transparent;
      border:none;
      padding:0;
      color:#111;
    }

    /* Dark theme overrides */
    [data-theme="batman"] aside,
    [data-theme="batman"] .sidebar-top,
    [data-theme="batman"] .stages{
      background:var(--bg);
      color:var(--ink);
    }
    [data-theme="batman"] .sidebar-brand span,
    [data-theme="batman"] .new-casefile,
    [data-theme="batman"] details.stage > summary,
    [data-theme="batman"] .case-link{
      color:var(--ink);
    }
    [data-theme="batman"] details.stage[open] > summary,
    [data-theme="batman"] details.stage.empty > summary,
    [data-theme="batman"] details.stage.active-open > summary,
    [data-theme="batman"] details.stage.has-items{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] details.stage > summary{
      background:#7f7f7f !important;
      border-color:#7f7f7f !important;
    }
    [data-theme="batman"] details.stage:not(.has-items) > summary{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] details.stage.has-items > summary{
      background:transparent;
    }
    [data-theme="batman"] .case-link{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#fff;
    }
    [data-theme="batman"] .case-link.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    [data-theme="batman"] .case-link:hover{
      background:#bfbfbf;
    }
    [data-theme="batman"] .count{
      color:#fff;
    }
    [data-theme="batman"] .chat,
    [data-theme="batman"] .chat-empty{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#fff;
    }
    [data-theme="batman"] .msg{
      background:#595959;
      border-color:#595959;
      color:#fff;
    }
    [data-theme="batman"] .msg.user{
      background:#f2f2f2;
      border-color:#f2f2f2;
      color:#000;
    }
    [data-theme="batman"] .composer-shell{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] .compass-pill{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#000;
    }
    [data-theme="batman"] .compass-pill.active{
      background:#bfbfbf;
      border-color:#000;
      color:#000;
    }
    [data-theme="batman"] .compass-label,
    [data-theme="batman"] .compass-top,
    [data-theme="batman"] .compass-top .right{
      color:#fff;
    }
    [data-theme="batman"] .compass-actions{
      color:#000;
    }
    [data-theme="batman"] input#msg{
      color:#000;
    }
    [data-theme="batman"] input#msg::placeholder{
      color:#000;
    }

    .stages{
      padding:10px 8px 12px 8px;
      overflow:auto;
      min-height:0;
    }

    details.stage{
      border:none;
      margin:10px 0;
    }
    details.stage > summary{
      list-style:none;
      cursor:pointer;
      font-weight:900;
      padding:8px 8px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    details.stage > summary::-webkit-details-marker{display:none;}
    details.stage[open] > summary{background:#fff;}
    .count{
      font-weight:800;
      color:var(--muted);
      font-size:var(--fs-12);
      padding-left:10px;
    }
    .case-list{
      margin:0;
      padding:6px 0 8px 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }
    .case-link{
      width:auto;
      min-width:80%;
      max-width:94%;
      text-align:left;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--soft);
      background:#f4efe8;
      cursor:pointer;
      font-weight:500;
      color:#111;
    }
    .case-link:hover{background:var(--panel)}
    .case-link.active{
      background:var(--active);
      border-color:var(--ink);
      color:var(--ink);
      font-weight:800;
    }
    .drop-target{
      outline:2px dashed #111;
      outline-offset:2px;
    }
    details.stage.empty > summary{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:999px;
      padding:6px 10px;
    }
    details.stage.active-folded > summary{
      background:var(--active);
      border:1px solid var(--line);
    }
    details.stage.has-items{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:20px;
      padding:6px 8px 8px 8px;
      margin-bottom:22px;
    }
    details.stage.active-folded,
    details.stage.active-open{
      box-shadow:0 12px 22px rgba(29,35,42,.12);
    }
    details.stage.active-open.has-items{
      box-shadow:0 12px 22px rgba(29,35,42,.12);
    }
    details.stage.active-open > summary{
      background:#fff;
      border:1px solid var(--soft);
    }
    details.stage.has-items > summary{
      border-radius:14px;
      padding:6px 10px;
      margin-bottom:2px;
      border:none;
    }
    details.stage.has-items:not([open]) > summary{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:999px;
      padding:6px 10px;
      margin-bottom:0;
    }
    details.stage.has-items .case-list{
      background:transparent;
      border:none;
      border-radius:0 0 16px 16px;
      padding:6px 0 8px 0;
    }

    /* Profile card */
    .profile-card{
      margin-top:auto;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
    }
    .avatar{
      width:44px;height:44px;border-radius:50%;
      overflow:hidden;
      border:1px solid #999;
      flex:0 0 auto;
      background:#fff;
    }
    .avatar img{width:100%;height:100%;display:block}
    .pc-meta{min-width:0;display:flex;flex-direction:column;gap:4px}
    .pc-name{font-weight:900}
    .pc-tier{font-weight:700;color:var(--muted)}
    .pc-gear-wrap{
      position:relative;
      margin-left:8px;
    }
    .pc-gear{
      width:32px;height:32px;border-radius:999px;
      border:1px solid var(--soft);
      background:#fff;
      display:grid; place-items:center;
      cursor:pointer;
      padding:0;
    }
    .pc-gear:hover{background:var(--panel)}
    .pc-menu{
      position:absolute;
      left:0;
      bottom:40px;
      display:none;
      flex-direction:column;
      gap:6px;
      background:#fff;
      border:1px solid var(--soft);
      border-radius:12px;
      padding:8px 10px;
      box-shadow:0 10px 24px rgba(29,35,42,.12);
      min-width:160px;
      z-index:20;
    }
    .pc-gear-wrap.open .pc-menu{
      display:flex;
    }
    .pc-menu button,
    .pc-menu a{
      background:transparent; border:none; padding:0; cursor:pointer; font:inherit;
      color:#111; display:flex; gap:6px; align-items:center;
      text-align:left;
      font-size:var(--fs-14);
      font-weight:600;
      font-family:var(--sans);
      text-decoration:none;
      
    }
    .pc-menu button.active{
      font-weight:800;
    }
    .pc-user{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .case-link:focus-visible,
    .compass-pill:focus-visible,
    .pc-gear:focus-visible,
    .brand-logo:focus-visible,
    .btn:focus-visible,
    .new-casefile:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }


    /* Main area */
    main{
      grid-row:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .label{font-weight:700}
    .value{font-weight:600}

    /* Chat container */
    .chat{
      flex:1 1 auto;
      min-height:0;
      border-top:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding:14px;
      gap:12px;
      overflow-y:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:0 16px 0 16px;
    }
    .chat-empty{
      flex:1 1 auto;
      border:1px dashed var(--line);
      border-radius:14px;
      background:var(--panel);
      padding:16px;
      color:var(--muted);
      font-size:var(--fs-14);
      display:flex;
      align-items:center;
    }
    .messages{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:auto;
    }
    .msg{
      max-width:72%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.4;
      font-size:var(--fs-14);
      border:1px solid var(--soft);
      background:#fff;
    }
    .msg.user{
      align-self:flex-end;
      background:var(--active);
      border-color:var(--line);
    }
    .msg.assistant{
      align-self:flex-start;
    }
    .typing{
      display:none;
      font-size:var(--fs-12);
      color:var(--muted);
    }
    .markdown-view{
      flex:1 1 auto;
      min-height:0;
      padding:14px;
      overflow:auto;
      background:#fff;
    }
    .md-shell{
      border:1px solid var(--line);
      border-radius:2px;
      background:var(--panel);
      padding:12px;
      font-family:var(--mono);
      font-size:var(--fs-14);
      white-space:pre-wrap;
      line-height:1.5;
    }

    /* Composer */
    .composer{
      padding:10px 14px 12px 0;
      border-top:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .composer-shell{
      border:1px solid var(--soft);
      border-radius:20px;
      padding:10px 12px;
      background:#fff;
      box-shadow:0 12px 22px rgba(29,35,42,.12);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .inputbar{
      display:flex;
      align-items:center;
      gap:10px;
      border:none;
      border-radius:0;
      padding:6px 0 2px 0;
      background:transparent;
      box-shadow:none;
    }
    .btn{
      width:32px;height:32px;border-radius:999px;
      border:1px solid var(--soft);
      display:grid; place-items:center;
      cursor:pointer;
      background:#fff;
      font-weight:900;
      user-select:none;
    }
    .btn:hover{background:var(--panel)}
    .btn.icon{
      font-family:var(--mono);
      font-weight:900;
    }
    .btn.wave{
      border-color:var(--accent);
      background:var(--accent);
      color:#fff;
    }
    .btn.wave:hover{background:#0c5256}
    input[type="text"]{
      border:none;
      outline:none;
      flex:1 1 auto;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
      color:var(--ink);
    }
    input[type="text"]::placeholder{
      color:var(--muted);
    }
    .hint{
      display:flex;
      gap:10px;
      color:var(--muted);
      font-size:var(--fs-14);
      justify-content:center;
      text-align:center;
    }

    .compass{
      border:none;
      border-radius:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:transparent;
      box-shadow:none;
    }
    .compass-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:var(--fs-15);
      font-weight:600;
    }
    .compass-top .right{
      margin-left:auto;
      text-align:right;
      color:var(--ink);
      font-weight:600;
      font-size:var(--fs-14);
    }
    .compass-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .compass-label{
      font-family:var(--sans);
      font-size:var(--fs-14);
      color:var(--muted);
      font-weight:400;
    }
    .compass-steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-size:var(--fs-14);
    }
    .compass-pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 10px;
      background:var(--panel);
      cursor:pointer;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
    }
    .compass-pill.active{
      background:var(--active);
      border-color:var(--ink);
      color:var(--ink);
      font-weight:700;
    }
    .compass-actions{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
    }
    .compass-clear{
      color:var(--muted);
    }

    .guard-banner{
      position:fixed;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:var(--fs-12);
      z-index:2000;
      display:none;
    }
    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-size:var(--fs-14);
      box-shadow:0 10px 24px rgba(29,35,42,.08);
      display:none;
      z-index:2000;
    }
    .guarded{
      filter:blur(2px);
      pointer-events:none;
      user-select:none;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(520px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
    }
    .modal h3{margin:0 0 10px 0; font-size:var(--fs-18)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight:900;
      font-size:var(--fs-14);
    }
    .field input{
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:10px;
      font-size:var(--fs-14);
      font-weight:700;
    }
    .modal-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .action{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel);
      font-weight:900;
      cursor:pointer;
    }
    .action.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .action:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

  </style>
</head>

<body>
  <!--
    Integration Notes (App)
    - On load: getMe, listCasefilesByStage, getMessages(activeCase)
    - Send message: DataAdapter.sendMessage(caseId, payload) -> Orchestrator
    - Drag stage: DataAdapter.updateCasefileStage(caseId, stage)
  -->
  <div class="guard-banner" id="guardBanner">Guard active: redirecting to auth/onboarding (demo only)</div>
  <div class="toast" id="toast"></div>
  <div class="wrap">
    <div class="app" role="application" aria-label="SignalBench beta v0.1">

      <!-- Sidebar -->
      <aside>
        <div class="sidebar-top">
          <div class="sidebar-brand">
            <div class="brand-menu">
              <button class="brand-logo" type="button" aria-label="Open navigation">
                <img src="icons/logo1_round_44.png" alt="SignalBench logo" />
              </button>
              <div class="brand-panel" role="menu">
                <a href="landing.html" role="menuitem">Landing</a>
                <a href="auth.html" role="menuitem">Auth</a>
                <a href="onboarding.html" role="menuitem">Onboarding</a>
                <a href="casefile_new.html" role="menuitem">Casefile Setup</a>
                <a href="app.html" role="menuitem">App</a>
                <a href="settings.html" role="menuitem">Settings</a>
                <a href="feedback.html" role="menuitem">Feedback</a>
              </div>
            </div>
            <span>SignalBench</span>
          </div>
          <button class="new-casefile" id="btnNewCasefile" type="button">+ New Casefile</button>
        </div>

        <div class="stages" id="stages">
          <!-- FOLD/UNFOLD: use <details> per stage -->
          <details class="stage" open data-stage="screen">
            <summary>
              <span>Screen</span>
              <span class="count" id="count-screen">0</span>
            </summary>
            <ul class="case-list" id="list-screen"></ul>
          </details>

          <details class="stage" open data-stage="validate">
            <summary>
              <span>Validate</span>
              <span class="count" id="count-validate">0</span>
            </summary>
            <ul class="case-list" id="list-validate"></ul>
          </details>

          <details class="stage" open data-stage="prepare">
            <summary>
              <span>Prepare</span>
              <span class="count" id="count-prepare">0</span>
            </summary>
            <ul class="case-list" id="list-prepare"></ul>
          </details>

          <details class="stage" open data-stage="advance">
            <summary>
              <span>Advance</span>
              <span class="count" id="count-advance">0</span>
            </summary>
            <ul class="case-list" id="list-advance"></ul>
          </details>

          <details class="stage" open data-stage="launch">
            <summary>
              <span>Launch</span>
              <span class="count" id="count-launch">0</span>
            </summary>
            <ul class="case-list" id="list-launch"></ul>
          </details>

          <details class="stage" open data-stage="closed">
            <summary>
              <span>Closed</span>
              <span class="count" id="count-closed">0</span>
            </summary>
            <ul class="case-list" id="list-closed"></ul>
          </details>
        </div>

        <div class="profile-card">
          <div class="pc-user">
            <div class="avatar">
              <img src="icons/newuser.jpg" alt="User avatar" />
            </div>
            <div class="pc-meta">
              <div class="pc-name">Brant Nieminski</div>
              <div class="pc-tier">Executive Tier</div>
            </div>
          </div>
          <div class="pc-gear-wrap">
            <button class="pc-gear" type="button" aria-label="Open menu">
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1Z"></path>
              </svg>
            </button>
            <div class="pc-menu" role="menu" aria-label="Profile menu">
              <button id="btnProfile" type="button" role="menuitem">Profile</button>
              <button id="btnStory" type="button" role="menuitem">Storybook</button>
              <a href="settings.html" role="menuitem">Settings</a>
              <a href="feedback.html" role="menuitem">Feedback</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main>
        <section class="chat" id="chat" aria-label="Chat">
          <div class="chat-empty" id="chatEmpty">
            No messages yet. Start with a common next step or ask a question to begin.
          </div>
          <div class="messages" id="messages" aria-live="polite"></div>
          <div class="typing" id="typing">Assistant is typing…</div>
        </section>

        <section class="markdown-view" id="markdownView" aria-label="Read-only Markdown" style="display:none;">
          <div class="md-shell" id="markdownContent"></div>
        </section>

        <div class="composer" aria-label="Composer">
          <div class="composer-shell">
            <div class="compass" id="compass">
              <div class="compass-top">
                <span id="compassActive">No active casefile selected</span>
                <span class="right" id="compassStageMeta">Stage: —</span>
              </div>
              <div class="compass-actions">
                <span class="compass-label">Next, we can:</span>
                <span class="compass-steps" id="compassSteps"></span>
                
              </div>
            </div>

            <div class="inputbar">
              <!-- Attach (eventual file picker) -->
              <button class="btn icon" id="btnAttach" type="button" aria-label="Attach">+</button>

              <!-- Main text input -->
              <input id="msg" type="text" placeholder="... or you can continue freeform here" autocomplete="off" />

              <!-- Microphone (stub) -->
              <button class="btn" id="btnMic" type="button" aria-label="Transcribe">
                <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 1a4 4 0 0 1 4 4v6a4 4 0 0 1-8 0V5a4 4 0 0 1 4-4z"></path>
                  <path d="M19 11a7 7 0 0 1-14 0"></path>
                  <path d="M12 18v4"></path>
                  <path d="M8 22h8"></path>
                </svg>
              </button>

              <!-- 2-way voice mode (stub) -->
              <button class="btn wave" id="btnVoice" type="button" aria-label="2-way voice">
                <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 12h2"></path>
                  <path d="M7 5v14"></path>
                  <path d="M12 8v8"></path>
                  <path d="M17 4v16"></path>
                  <path d="M21 12h2"></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="hint">
            <span>Demo environment. Data shown here is local and non‑persistent.</span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- New Casefile Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Create new casefile">
    <div class="modal">
      <h3>New Casefile</h3>

      <div class="grid">
        <label class="field">
          <span>Role</span>
          <input id="inputRole" type="text" placeholder="e.g. VP Operations" />
        </label>
        <label class="field">
          <span>Company</span>
          <input id="inputCompany" type="text" placeholder="e.g. Amazon" />
        </label>
      </div>

      <div class="modal-actions">
        <button class="action" id="btnCancel" type="button">Cancel</button>
        <button class="action primary" id="btnCreate" type="button" disabled>Create</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * UI Shell behavior only:
     * - Create new casefile into Screen stage
     * - Selecting a casefile sets Active Casefile header
     * - Fold/unfold per stage is native via <details>
     * - No persistence; state resets on refresh
     */

    const MockAdapter = (() => {
      let store = UIStore.load();

      const persist = () => UIStore.save(store);

      return {
        // Adapter contract (UI -> Orchestrator/SQL)
        // getMe() -> {id, email}
        // createU01({ fullName, email, resumeRaw, resumeText? }) -> U01
        // createCasefile({ role, company, stage }) -> casefile
        // createU03(caseId, { jdRaw, jdText? }) -> U03
        // listCasefilesByStage() -> casefile[]
        // getMessages(caseId) -> message[]
        // sendMessage(caseId, {id, role, content, createdAt}) -> message
        // updateCasefileStage(caseId, stage) -> void
        getMe(){
          return store.me;
        },
        createU01(payload){
          store.u01 = { ...payload, createdAt: new Date().toISOString() };
          persist();
          return store.u01;
        },
        createCasefile(payload){
          const cf = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
            role: payload.role,
            company: payload.company,
            stage: payload.stage || "screen"
          };
          store.casefiles.push(cf);
          persist();
          return cf;
        },
        createU03(caseId, payload){
          store.u03 = store.u03 || {};
          store.u03[caseId] = { ...payload, createdAt: new Date().toISOString() };
          persist();
          return store.u03[caseId];
        },
        listCasefilesByStage(){
          return [...store.casefiles];
        },
        setActiveCasefile(caseId){
          store.activeCaseId = caseId;
          persist();
        },
        getActiveCasefile(){
          return store.activeCaseId;
        },
        updateCasefileStage(caseId, stage){
          const cf = store.casefiles.find(c => c.id === caseId);
          if (!cf) return;
          cf.stage = stage;
          persist();
          console.log("[DataAdapter] updateCasefileStage", { caseId, stage });
        },
        getMessages(caseId){
          return store.messages[caseId] ? [...store.messages[caseId]] : [];
        },
        sendMessage(caseId, payload){
          if (!store.messages[caseId]) store.messages[caseId] = [];
          store.messages[caseId].push(payload);
          persist();
          return payload;
        }
      };
    })();

    const DataAdapter = MockAdapter;

    const state = {
      activeCaseId: null,
      activeView: "casefile", // casefile | profile | storybook
      casefiles: [], // {id, role, company, stage}
      messages: [],
      activeStage: "Screen",
      intentKey: null,
      compass: {
        stage: "Screen",
        where: "No active casefile yet.",
        suggestedPrompt: "",
        steps: [],
        selectedStepLabel: null
      }
    };

    const COMPASS_CONFIG = {
      screen: {
        goal: "orient, extract requirements and decide whether to invest.",
        steps: [
          { label: "Deconstruct role", intent_key: "screen.deconstruct_role", seed_prompt: "Deconstruct this JD into real success outcomes." },
          { label: "Check fit", intent_key: "screen.check_fit_gaps", seed_prompt: "Assess my fit signals and misfit risks. Ask me questions that may close gaps and build out my Storybook." },
          { label: "Evaluate risks and opportunities", intent_key: "screen.evaluate_risks_opportunities", seed_prompt: "Identify downside risks and upside opportunities before I invest more time." }
        ]
      },
      validate: {
        goal: "establish truth sufficiency and build confidence through evidence.",
        steps: [
          { label: "Stress test", intent_key: "validate.stress_test", seed_prompt: "Challenge my claims against the JD requirements. Ask me questions that may close gaps and build out my Storybook." },
          { label: "Fill gaps", intent_key: "validate.fill_gaps", seed_prompt: "Tell me what evidence is missing and why. How might we fill the gaps?" },
          { label: "Prepare application", intent_key: "validate.prepare_application", seed_prompt: "Optimize my resume using Storybook facts for screening." }
        ]
      },
      prepare: {
        goal: "optimize signal expression inside known truth boundaries.",
        steps: [
          { label: "Build narrative spine", intent_key: "prepare.build_narrative_spine", seed_prompt: "Draft a narrative spine for this role to anchor what we know from the JD to what we might expect downstream." },
          { label: "Prepare stories", intent_key: "prepare.prepare_stories", seed_prompt: "Pick and develop my top 3-5 stories with me that will likely be asked in the interview. Ask me questions along the way." },
          { label: "Clarify signal", intent_key: "prepare.clarify_signal", seed_prompt: "Help me tighten my evidence-based signals without adding claims." }
        ]
      },
      advance: {
        goal: "learn and recalibrate as real interactions occur.",
        steps: [
          { label: "Debrief interview", intent_key: "advance.debrief_interview", seed_prompt: "Help me debrief: what happened & what it meant. I'll start with a narrative, then you ask necessary questions." },
          { label: "Update hypothesis", intent_key: "advance.update_hypothesis", seed_prompt: "Update employer intent, facts and hypotheses based on new signals from the interviews." },
          { label: "Draft follow-up", intent_key: "advance.draft_follow_up", seed_prompt: "Draft a tailored follow-up reinforcing key alignment." }
        ]
      },
      launch: {
        goal: "negotiate eyes-open; consolidate evidence; surface residual risk before acceptance.",
        steps: [
          { label: "Pressure test", intent_key: "launch.pressure_test", seed_prompt: "List top risks still unresolved before I accept." },
          { label: "Negotiate terms", intent_key: "launch.negotiate_terms", seed_prompt: "Help me negotiate comp, scope, and authority." },
          { label: "Plan entry", intent_key: "launch.plan_entry", seed_prompt: "Draft a 30-60-90 entry plan for this role. Include all facts, hypotheses and unknowns as well as cultural and personal insights." }
        ]
      },
      closed: {
        goal: "archived casefiles for reference.",
        steps: [
          { label: "Extract signals", intent_key: "closed.extract_signals", seed_prompt: "Extract reusable signals and stories for future roles." },
          { label: "Do retrospective", intent_key: "closed.do_retrospective", seed_prompt: "Reflect on what we learned through the journey of this casefile." }
        ]
      }
    };

    const el = (id) => document.getElementById(id);

    const appShell = document.querySelector(".app");
    const guardBanner = el("guardBanner");
    const toast = el("toast");
    const modalBackdrop = el("modalBackdrop");
    const btnNewCasefile = el("btnNewCasefile");
    const btnCancel = el("btnCancel");
    const btnCreate = el("btnCreate");

    const inputRole = el("inputRole");
    const inputCompany = el("inputCompany");

    const activeCasefile = null;
    const compassActive = el("compassActive");
    const compassStageMeta = el("compassStageMeta");
    const chat = el("chat");
    const chatEmpty = el("chatEmpty");
    const messagesEl = el("messages");
    const typingEl = el("typing");
    const markdownView = el("markdownView");
    const markdownContent = el("markdownContent");
    const composer = document.querySelector(".composer");
    const compassWhere = el("compassWhere");
    const compassSteps = el("compassSteps");
    const msgInput = el("msg");
    const btnClearDemo = el("btnClearDemo");

    const profileMd = [
      "# U01 — Candidate Profile (Read Only)",
      "",
      "- Name: Brant Nieminski",
      "- Title: Executive Tier",
      "- Summary: Placeholder profile markdown for Beta 1 demo.",
      "",
      "## Evidence (Resume)",
      "- Resume uploaded: Yes",
      "- Raw text stored verbatim (append-only)"
    ].join("\n");

    const storyMd = [
      "# U02 — Storybook (Read Only)",
      "",
      "- Placeholder storybook markdown for Beta 1 demo.",
      "- Additive evidence stories captured over time.",
      "",
      "## Stories",
      "1. Example story entry (to be replaced by real U02 content)."
    ].join("\n");

    // Composer stubs
    el("btnAttach").addEventListener("click", () => {
      alert("Attach files (stub). Later: open file picker + upload connector.");
    });
    el("btnMic").addEventListener("click", () => {
      alert("Transcription (stub). Later: Web Speech API / service integration.");
    });
    el("btnVoice").addEventListener("click", () => {
      alert("2-way voice mode (stub). Later: realtime voice stack.");
    });
    if (btnClearDemo){
      btnClearDemo.addEventListener("click", () => {
        UIStore.clear();
        window.location.reload();
      });
    }

    el("btnProfile").addEventListener("click", () => setView("profile"));
    el("btnStory").addEventListener("click", () => setView("storybook"));
    const btnProfile = el("btnProfile");
    const btnStory = el("btnStory");
    const gearWrap = document.querySelector(".pc-gear-wrap");
    const gearBtn = document.querySelector(".pc-gear");
    const brandMenus = document.querySelectorAll(".brand-menu");

    if (gearBtn && gearWrap){
      gearBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        gearWrap.classList.toggle("open");
      });
      document.addEventListener("click", (e) => {
        if (!gearWrap.contains(e.target)){
          gearWrap.classList.remove("open");
        }
      });
    }
    if (brandMenus.length){
      brandMenus.forEach((menu) => {
        const trigger = menu.querySelector(".brand-logo");
        if (!trigger) return;
        trigger.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          menu.classList.toggle("open");
        });
      });
      document.addEventListener("click", (e) => {
        document.querySelectorAll(".brand-menu.open").forEach((menu) => {
          if (!menu.contains(e.target)) menu.classList.remove("open");
        });
      });
    }

    // New casefile modal open/close
    btnNewCasefile.addEventListener("click", () => {
      openModal();
    });

    btnCancel.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    function openModal(){
      modalBackdrop.style.display = "flex";
      inputRole.value = "";
      inputCompany.value = "";
      btnCreate.disabled = true;
      inputRole.focus();
    }

    function closeModal(){
      modalBackdrop.style.display = "none";
    }

    // Enable Create button only when role + company exist
    [inputRole, inputCompany].forEach(inp => {
      inp.addEventListener("input", () => {
        btnCreate.disabled = !(inputRole.value.trim() && inputCompany.value.trim());
      });
    });

    btnCreate.addEventListener("click", () => {
      const role = inputRole.value.trim();
      const company = inputCompany.value.trim();
      const cf = DataAdapter.createCasefile({ role, company, stage: "screen" });
      state.casefiles = DataAdapter.listCasefilesByStage();
      closeModal();
      render();
      setActive(cf.id);
      ensureStageOpen(cf.stage);
    });

    function ensureStageOpen(stage){
      const details = document.querySelector(`details.stage[data-stage="${stage}"]`);
      if (details) details.open = true;
    }

    function setActive(caseId){
      state.activeCaseId = caseId;
      DataAdapter.setActiveCasefile(caseId);
      const cf = state.casefiles.find(c => c.id === caseId);
      if (!cf) return;

      setView("casefile");
      updateCompass(cf);
      render();
      loadMessages(caseId);

      // Update selected highlight
      document.querySelectorAll(".case-link").forEach(btn => btn.classList.remove("active"));
      const activeBtn = document.querySelector(`.case-link[data-id="${caseId}"]`);
      if (activeBtn) activeBtn.classList.add("active");
    }

    // Render case lists by stage + counts
    function render(){
      const stages = ["screen","validate","prepare","advance","launch","closed"];
      for (const s of stages){
        const list = el(`list-${s}`);
        const count = el(`count-${s}`);
        const details = document.querySelector(`details.stage[data-stage="${s}"]`);
        list.innerHTML = "";

        const items = state.casefiles.filter(c => c.stage === s);
        count.textContent = items.length;
        if (details){
          details.classList.toggle("has-items", items.length > 0);
          details.classList.toggle("empty", items.length === 0);
          const activeIsHere = state.activeCaseId
            && state.casefiles.find(c => c.id === state.activeCaseId)?.stage === s;
          details.classList.toggle("active-folded", !!activeIsHere && !details.open);
          details.classList.toggle("active-open", !!activeIsHere && details.open);
        }

        for (const cf of items){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "case-link";
          btn.dataset.id = cf.id;
          btn.textContent = `${cf.role}, ${cf.company}`;
          btn.addEventListener("click", () => setActive(cf.id));
          btn.draggable = true;
          btn.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", cf.id);
            e.dataTransfer.effectAllowed = "move";
          });
          list.appendChild(btn);
        }
      }

      // If nothing is active and we have casefiles, keep headers sane
      if (!state.activeCaseId){
        updateCompass(null);
        state.messages = [];
        renderMessages();
      }
    }

    function bindStageDnD(){
      document.querySelectorAll("details.stage").forEach((details) => {
        const stage = details.dataset.stage;
        const summary = details.querySelector("summary");
        const list = details.querySelector(".case-list");

        [summary, list].forEach((target) => {
          target.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            details.classList.add("drop-target");
          });
          target.addEventListener("dragleave", () => {
            details.classList.remove("drop-target");
          });
          target.addEventListener("drop", (e) => {
            e.preventDefault();
            details.classList.remove("drop-target");
            const caseId = e.dataTransfer.getData("text/plain");
            moveCasefile(caseId, stage);
          });
        });
      });
    }

    // Optional: you can wire these to future “advance stage” actions
    // moveCasefile(caseId, "prepare") etc.
    function moveCasefile(caseId, newStage){
      const cf = state.casefiles.find(c => c.id === caseId);
      if (!cf) return;
      cf.stage = newStage;
      DataAdapter.updateCasefileStage(caseId, newStage);
      render();
      setActive(caseId);
      ensureStageOpen(newStage);
      showToast(`Moved casefile to ${stageLabel(newStage)}.`);
    }

    // Message input: send on Enter
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        const val = e.target.value.trim();
        if (!val) return;
        e.preventDefault();
        sendMessage(val);
        msgInput.value = "";
      }
    });
    const promptChangedTooMuch = (input, seed) => {
      const a = (seed || "").trim();
      const b = (input || "").trim();
      if (!a) return false;
      if (b.startsWith(a)) return false; // allow any additions after seed
      const m = a.length;
      const n = Math.min(b.length, m);
      const bSlice = b.slice(0, m);
      const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++){
        for (let j = 1; j <= n; j++){
          const cost = a[i - 1] === bSlice[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      const distance = dp[m][n];
      return (distance / m) > 0.2;
    };

    msgInput.addEventListener("input", () => {
      if (state.intentSeedPrompt && promptChangedTooMuch(msgInput.value, state.intentSeedPrompt)){
        state.intentKey = null;
        state.intentSeedPrompt = null;
        state.compass.selectedStepLabel = null;
        renderCompass();
      }
    });

    function setView(view){
      state.activeView = view;
      const isCasefile = view === "casefile";
      chat.style.display = isCasefile ? "flex" : "none";
      el("compass").style.display = isCasefile ? "flex" : "none";
      composer.style.display = isCasefile ? "flex" : "none";
      markdownView.style.display = isCasefile ? "none" : "block";
      btnProfile.classList.toggle("active", view === "profile");
      btnStory.classList.toggle("active", view === "storybook");

      if (view === "profile"){
        markdownContent.textContent = profileMd;
      } else if (view === "storybook"){
        markdownContent.textContent = storyMd;
      }
    }

    function stageLabel(stage){
      const map = {
        screen: "Screen",
        validate: "Validate",
        prepare: "Prepare",
        advance: "Advance",
        launch: "Launch",
        closed: "Closed"
      };
      return map[stage] || "Screen";
    }

    function updateCompass(cf){
      const stageKey = cf?.stage || "screen";
      const config = COMPASS_CONFIG[stageKey] || COMPASS_CONFIG.screen;
      const stage = stageLabel(stageKey);

      state.activeStage = stage;
      state.intentKey = null;

      if (!cf){
        if (compassActive) compassActive.textContent = "No active casefile selected";
      } else {
        if (compassActive) compassActive.textContent = `Active Casefile: ${cf.role}, ${cf.company}`;
      }
      if (compassStageMeta) compassStageMeta.textContent = `Stage: ${stage} - ${config.goal}`;

      state.compass = {
        stage,
        where: config.goal,
        suggestedPrompt: "",
        steps: config.steps || [],
        selectedStepLabel: null
      };
      renderCompass();
    }

    function renderCompass(){
      if (compassWhere){
        compassWhere.textContent = `${state.compass.stage} ? ${state.compass.where}`;
      }
      compassSteps.innerHTML = "";
      for (const step of state.compass.steps){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "compass-pill";
        btn.textContent = step.label;
        if (state.compass.selectedStepLabel === step.label){
          btn.classList.add("active");
        }
        btn.addEventListener("click", () => {
          state.compass.selectedStepLabel = step.label;
          state.intentKey = step.intent_key || null;
          state.intentSeedPrompt = step.seed_prompt || "";
          msgInput.value = step.seed_prompt || "";
          msgInput.focus();
          renderCompass();
        });
        compassSteps.appendChild(btn);
      }
    }

    function loadMessages(caseId){
      state.messages = DataAdapter.getMessages(caseId);
      renderMessages();
    }

    function renderMessages(){
      messagesEl.innerHTML = "";
      if (!state.messages.length){
        chatEmpty.style.display = "flex";
        chatEmpty.textContent = emptyGuidance(state.activeStage);
        return;
      }
      chatEmpty.style.display = "none";
      for (const msg of state.messages){
        const div = document.createElement("div");
        div.className = `msg ${msg.role}`;
        div.textContent = msg.content;
        messagesEl.appendChild(div);
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function emptyGuidance(stage){
      const copy = {
        Screen: "No messages yet. Add the JD or key context to start screening this role.",
        Validate: "No messages yet. List missing facts or risks you want to validate.",
        Prepare: "No messages yet. Start tuning your narrative or signals for this role.",
        Advance: "No messages yet. Capture a debrief or ask how to prepare for the next round.",
        Launch: "No messages yet. Share offer details or decision constraints to evaluate.",
        Closed: "This casefile is closed. Create a new casefile to begin again."
      };
      return copy[stage] || "No messages yet. Start with a common next step or ask a question to begin.";
    }

    function sendMessage(text){
      if (!state.activeCaseId){
        alert("Select a casefile before sending a message.");
        return;
      }
      const storeSnapshot = UIStore.load();
      const userMsg = DataAdapter.sendMessage(state.activeCaseId, {
        id: String(Date.now()) + Math.random().toString(16).slice(2),
        role: "user",
        content: text,
        createdAt: new Date().toISOString(),
        intent_key: state.intentKey || null,
        stage: state.activeStage,
        casefile_id: state.activeCaseId,
        has_u01: !!storeSnapshot.u01,
        has_u02: !!storeSnapshot.u02
      });
      state.intentKey = null;
      state.intentSeedPrompt = null;
      state.compass.selectedStepLabel = null;
      renderCompass();
      state.messages.push(userMsg);
      renderMessages();
      typingEl.style.display = "block";

      const full = "Got it. I’ll use that to guide the next step for this casefile.";
      const assistantMsg = {
        id: String(Date.now()) + Math.random().toString(16).slice(2),
        role: "assistant",
        content: "",
        createdAt: new Date().toISOString()
      };
      state.messages.push(assistantMsg);
      renderMessages();

      let i = 0;
      const tick = () => {
        i += 1;
        assistantMsg.content = full.slice(0, i);
        renderMessages();
        if (i < full.length){
          setTimeout(tick, 12);
        } else {
          typingEl.style.display = "none";
          DataAdapter.sendMessage(state.activeCaseId, assistantMsg);
          renderMessages();
        }
      };
      setTimeout(tick, 120);
    }

    function enforceDemoGuards(){
      const demoAuth = { isAuthed: true, isOnboarded: true };
      const route = window.location.hash || "#/app";
      let allowed = true;
      if (route !== "#/auth" && !demoAuth.isAuthed) allowed = false;
      if (route === "#/app" && demoAuth.isAuthed && !demoAuth.isOnboarded) allowed = false;

      if (!allowed){
        guardBanner.style.display = "block";
        appShell.classList.add("guarded");
        window.location.hash = demoAuth.isAuthed ? "#/onboarding" : "#/auth";
      }
    }

    function showToast(message){
      if (!toast) return;
      toast.textContent = message;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        toast.style.display = "none";
      }, 1600);
    }

    // Initial render
    state.casefiles = DataAdapter.listCasefilesByStage();
    render();
    const lastActive = DataAdapter.getActiveCasefile();
    if (lastActive){
      setActive(lastActive);
    }
    updateCompass(null);
    bindStageDnD();
    enforceDemoGuards();

    // DEV HOOK (comment out anytime): seed an example
    // state.casefiles.push({id:"seed1", role:"VP Opex", company:"MacQueen", stage:"prepare"});
    // render(); setActive("seed1"); ensureStageOpen("prepare");
  </script>
</body>
</html>


